

> This document specifies the **requirements for the first MVP** (what to build and how it behaves).
> For the long-term vision and adaptive loop, see `sisy/docs/vision.md`.

## 0. MVP goal, scope, and non-goals

- **MVP goal:** Keep the user oriented on a viable **next step** with minimal interaction, even when the day changes.
- **MVP scope (must ship):**
  - Chat input available from every screen
  - Minimalist Present “now/next” view
  - Routine template storage/editing (basic)
  - Lightweight profile (“Me”) view for what the system knows
  - Simple reschedule + completion signals
- **Non-goals (MVP):**
  - Full calendar replacement / complex scheduling engine
  - Social / collaboration
  - Deep health analytics (medical-grade)

## 1. Brand identity & UX principles (MVP constraints)

- **Design language:** **Extreme Minimalism**
- **Interaction mood:** Like an old friend—present when needed, invisible when you are focused.
- **MVP UX constraints:**
  - **One-primary-action** per screen (everything else is secondary or hidden)
  - **No setup wall:** user can start with empty profile + empty routine
  - **Speed:** most interactions should be doable in <10 seconds

## 2. Information architecture

- **Bottom navigation:** Present / Routine / Me
- **Chat:** persistent input anchored above the nav, available everywhere

## 3. Functional modules (MVP requirements)

### The "Chat" Layer

SiSy is an always-available companion.

- **Persistent input (REQ-CHAT-1):** A chat input field is anchored above the navigation bar on **every screen** (Present, Routine, Me).
    
- **Context awareness (REQ-CHAT-2):** The input knows which tab is active and includes that context in the message payload.
  - **User Context:** The frontend injects the full `user_profile` and `user_routine` into the chat request (as `user_context`) so the agent has full visibility.
  - **Dynamic Hints:** The input placeholder changes to prompt relevant actions (e.g., "How is it going?" on Present, "Update profile?" on Me).
- **Smart Drawer (REQ-CHAT-3):** Tapping the input expands a drawer over current content showing recent chat history, without navigating away.
- **Message types (REQ-CHAT-4):** Support at least:
  - **State update:** “I’m exhausted”, “I have 20 minutes”
  - **Intent:** “Help me plan today”, “Move my next task”
  - **Capture:** “Remind me to …”, “I need to …”

**Acceptance criteria**
- **AC-CHAT-1:** Input is visible on Present/Routine/Me and remains usable after switching tabs.
- **AC-CHAT-2:** Opening/closing the drawer does not reset the underlying screen state.

### The Navigation Anchor

A minimalist bottom navigation bar allows instant switching between the core dimensions of the user's life.

- **Layout (REQ-NAV-1):** **Four** icon-based buttons located at the very bottom of the screen.
    
    1. **Present:** The minimalist page about the current or next Task.
        
    2. **Routine:** The page about the default routine template.
        
    3. **Me:** The page about the user profile, SiSy's learning about the user.

    4. **Settings:** A dedicated area for app-wide configuration and data management.
        
- **Behavior (REQ-NAV-2):** Single tap to switch. Double-tap on the active tab to scroll to the top (or refresh context).

**Acceptance criteria**
- **AC-NAV-1:** Switching tabs is instant and does not lose the current “now/next” task state.
- **AC-NAV-2:** Double-tap on active tab scrolls to top (or triggers refresh) consistently.

### 3.1 Present: Minimalist Command Center

- **Primary view (REQ-PRESENT-1):** A vertical timeline stack focused on the "Now" task, with reduced visibility for "Past" and "Next".
  - **3-Task Limit:** Only 3 tasks are rendered at once to maintain focus (Past, Now, Next).
  - **Most Recent Overdue Priority (Phase 4):** The "Now" task is defined as the **most recent overdue task** (or the next upcoming one if none are overdue). This prevents old tasks from blocking the flow.
  - **Past Context:** The immediate predecessor (uncompleted) is shown above the current task with lower opacity.
  - **Next Context:** The immediate successor is shown below the current task with lower opacity.

- **Interactions (Updated Phase 5/6):**
  - **Vertical Pan / Peek:** Users can drag the stack vertically to "peek" at past or future tasks. The stack snaps back to the center ("Now") on release.
  -   **Universal Swipe (Unified):** Swipe Right on ANY visible task to **Quick Complete** locally (instant feedback).
  -   **Details:** Tap any task to open the **Command Modal**.
      -   **Actionable:** Complete (with optional **comment/log**), Skip, or Delay.
      -   **Edit Routine:** Direct access to edit the underlying routine item configuration (e.g., permanent time change).

- **Empty state (REQ-PRESENT-2):** Show something relaxing and encouraging.

**Acceptance criteria**
- **AC-PRESENT-1:** App renders exactly 3 tasks (Past/Now/Next) max.
- **AC-PRESENT-2:** "Now" task is the most relevant item (nearest overdue or next upcoming).
- **AC-PRESENT-3:** Swipe Right triggers "Quick Complete" instantly.
- **AC-PRESENT-4:** Vertical drag reveals the stack and snaps back.
- **AC-PRESENT-5:** Tapping a task opens Details with Complete (w/ optional comment), Skip, Delay, and Edit-Routine options.

### 3.2 "Me" Interface

- **Function (REQ-ME-1):** Visualize the user profile as simple key-value fields organized into **Groups** (e.g., Basics / Health).
- **Layout (REQ-ME-2):** Render fields as **two-column rows** within their respective groups.
- **Customization (REQ-ME-4):** Users can customize all groups (create new groups, add fields to specific groups). Default groups (Basics, Health) are just starting points.
- **Long values (REQ-ME-3):** Values may be long strings and arbitrary text; the default overview should **truncate (ellipsis)** to keep rows compact.
  - When editing/viewing details, the full value should be accessible, inline edit mode for shot value or a dedicated detail view for long value).

- **Purpose:** Let users see how SiSy understands them.
- **Group Management (REQ-ME-5):**
  - **Atomic Deletion:** Deleting a group removes all attributes within it efficiently.
  - **Renaming:** Users can rename groups, which updates the group tag on all constituent attributes.

**Acceptance criteria**
- **AC-ME-1:** User can view all stored fields grouped by their "Group" attribute.
- **AC-ME-2:** User can edit or delete a field (even if “AI learned”) in MVP.
- **AC-ME-3:** User can create new profile fields and assign them to any Group (existing or new).
- **AC-ME-4:** User can delete an entire group and all its attributes in one action.


### 3.3 "Routine" Interface

- **Function (REQ-ROUTINE-1):** Store the user’s Routine Template (the default day structure).
    
- **Linkage (REQ-ROUTINE-2):** Routine is the “master template” referenced when generating today’s tasks.
- **Editing (REQ-ROUTINE-3):** User can add/edit/remove routine items. Modifications to routine item details (Title, Time, Auto-complete) must **immediately propagate** to any linked "todo" tasks for the current day.
- **Minimum editor UI (REQ-ROUTINE-4):**
  - **Timeline Layout:** Items are displayed in a timeline view (time on left, connected line, card on right).
  - **Modal Editing:** Tapping an item opens a detail modal to edit all fields.
  - **Fields:**
    - Title
    - Time (HH:MM)
    - **Description:** Optional details for the item. Supports **Markdown** formatting.
    - **Repeat Interval:** Custom days (default 1 for daily).
    - **Auto-complete toggle:** See REQ-ROUTINE-5.
  - **Delete action:** Available in modal with confirmation (in-modal logic).

-   **Auto-complete semantics (REQ-ROUTINE-5):**
  -   User can **opt an item into auto-completion** (e.g. “Wake up”).
  -   When an item is marked auto-completable, it should render with **lighter typography** so the user’s attention naturally lands on deliberate items (e.g. “Exercise”).

-   **Contextual Editing (REQ-ROUTINE-6):** The routine editor is accessible directly from the Task Details view of an active task, allowing for "in-the-moment" adjustments to the permanent plan.

**Acceptance criteria**
- **AC-ROUTINE-1:** Routine edits persist and immediately update any relevant pending (todo) tasks for the current day.
- **AC-ROUTINE-2:** Routine can be empty; app remains usable.
- **AC-ROUTINE-3:** User can modify items via modal (Title, Time, Description [Markdown supported], Repeat).
- **AC-ROUTINE-4:** User can toggle auto-complete on an item.
- **AC-ROUTINE-5:** Deletion is confirmed via modal UI ("Are you sure").
- **AC-ROUTINE-6:** User can view "History / Logs" for specific routine items within the editor modal, capturing completion comments and actions.
    

### 3.4 "Settings" Interface (REQ-SETTINGS)

- **Function (REQ-SETTINGS-1):** A dedicated area for app-wide configuration and data management, keeping the core "Routine" and "Me" tabs focused on daily usage.
- **Data Management (REQ-SETTINGS-2):**
    - **Import/Export Routine:** User can export their current routine structure (JSON/text) to clipboard/file and import it back. 
    - **Import/Export Profile:** User can export their profile data (JSON) and import it, allowing backup or transfer of learned facts.
    - **Load Template:** Pre-configured templates (e.g., "Wellness") to bootstrap the user's routine. 
    - **Confirmation (REQ-SETTINGS-3):** Critical data actions (like replacing routine) must use in-app Modals for confirmation on Web, avoiding native browser alerts for stability.

## 4. Core MVP flows (minimum)

- **Flow A — Start from nothing:** open app → Present empty state → user types intent in Chat → system creates a Task (source=`chat`) → Present shows it as the next step.
- **Flow B — Disruption:** user types a state update (“I’m exhausted”) → system suggests a revised next step.
- **Flow C — Reschedule:** user slides time tweak on Present → confirm → optional reason capture.
- **Flow D — Completion:** user marks done → optional feeling check → next task appears.
- **Flow E — Routine edit:** user edits Routine template → future plans reference it.
- **Flow F — Profile transparency:** user opens Me → sees learned fields → edits/deletes one.

## 5. Minimal data model & events (MVP)

- **Task**
  - `id`, `title`, `scheduled_time` (optional), `status` (todo/done), `source` (routine/chat/system)
  - `routine_item_id` (optional, links to master routine item)
- **RoutineItem**
  - `id`, `title`, `time` (optional), `auto_complete` (boolean, default=false)
  - `description` (optional string)
  - `repeat_interval` (optional number, default=1 for daily)
- **ProfileField**
  - `key`, `value`, `group` (string, default "Other"), `source` (user/learned), `updated_at`
- **Events to capture**
  - `task_completed`, `task_rescheduled`, `state_reported`, `profile_field_edited`
  - **Logs**: Linked to specific `routine_item_id` where applicable (e.g., skip comments, reschedule reasons).


## 6. MVP “done” checklist

- User can complete **Flows A–F** end-to-end without errors.
- Present stays minimalist (one primary line) while still supporting reschedule + done.
- Routine and profile are optional (empty is valid).

## 7. API endpoints (MVP)

> Assumption (MVP): single-user, no auth.
> Practical note: to avoid mixing data across test devices, every request should include an `X-Install-Id` header (a locally generated install/device id) and the backend should scope reads/writes by that id.
> All endpoints are JSON over HTTPS. Prefix: `/api/v0`.

### 7.1 Tasks

- **List tasks**
  - `GET /api/v0/tasks?status=todo|done&limit=50`
- **Create task** (used by Flow A and by assistant actions)
  - `POST /api/v0/tasks`
  - Body: `{ "title": "string", "scheduled_time": "ISO-8601|null", "source": "chat|routine|system" }`
- **Get task**
  - `GET /api/v0/tasks/{task_id}`
- **Update task**
  - `PATCH /api/v0/tasks/{task_id}`
  - Body: `{ "title": "string?", "scheduled_time": "ISO-8601|null?", "status": "todo|done?" }`
- **Complete task** (preferred explicit event)
  - `POST /api/v0/tasks/{task_id}/complete`
  - Body: `{ "completed_at": "ISO-8601", "feeling": "string|null" }`
- **Reschedule task**
  - `POST /api/v0/tasks/{task_id}/reschedule`
  - Body: `{ "scheduled_time": "ISO-8601|null", "reason": "string|null" }`

### 7.2 Present (now/next)

- **Get now/next view model**
  - `GET /api/v0/home`
  - Response: `{ "current": Task|null, "next": Task|null }`

### 7.3 Routine

- **Get routine**
  - `GET /api/v0/routine`
  - Response: `{ "items": [RoutineItem] }`
- **Replace routine (simple MVP)**
  - `PUT /api/v0/routine`
  - Body: `{ "items": [{ "id": "string?", "title": "string", "time": "string|null", "auto_complete": "boolean?" }] }`


### 7.4 Profile fields

- **List profile fields**
  - `GET /api/v0/profile/fields`
- **Upsert a field**
  - `PUT /api/v0/profile/fields/{key}`
  - Body: `{ "value": "string", "source": "user|learned" }`
- **Delete a field**
  - `DELETE /api/v0/profile/fields/{key}`

### 7.5 Chat (Chat)

- **Send message**
  - `POST /api/v0/chat` (Previously `/api/v0/chat/messages`)
  - Content-Type: `multipart/form-data`
  - Body:
    - `conversation_id`: "string|null"
    - `tab`: "home|routine|me"
    - `text`: "string"
    - `image`: File (optional)
    - `user_context`: JSON string (optional, contains `{ profile: ..., routine: ... }`)
  - Response (MVP shape):
    - `{ "conversation_id": "string", "assistant_text": "string", "actions": [Action] }`
  - `Action` examples:
    - `{ "type": "upsert_routine_item", "title": "New Task", "scheduled_time": "...", "status": "todo" }` (Create)
    - `{ "type": "upsert_routine_item", "id": "...", "status": "completed" }` (Update)
    - `{ "type": "upsert_profile_field", "key": "...", "value": "..." }`
    - `{ "type": "add_log", "message": "...", "level": "info" }`

- **Get recent history**
  - `GET /api/v0/chat/history?conversation_id=...&limit=50`

### 7.6 Events (optional but recommended)

> Use this if you want a single, append-only log for learning/debugging.

- `POST /api/v0/events`
  - Body: `{ "type": "task_completed|task_rescheduled|state_reported|profile_field_edited", "payload": {}, "occurred_at": "ISO-8601" }`

## 8. Stack choices (MVP implementation review)

### 8.1 Mobile app: React Native + Expo (start with Expo Go)

- **Verdict:** Good for MVP speed and iteration.
- **Recommendation:** Use **Expo Go** for early prototyping, but plan to switch to **EAS builds / Expo Dev Client** as soon as you need any native module not bundled in Expo Go (or when you start sharing test builds).
- **Key constraints to acknowledge upfront:**
  - **Streaming AI UX:** true token streaming can be awkward on RN depending on your networking approach; keep MVP tolerant of “single response” (non-streaming) and add streaming later.
  - **Storage/offline:** decide early whether “offline-first” is a goal. If not, keep client state light and treat backend as source of truth.

### 8.2 AI layer: Vercel AI SDK

- **Verdict:** Good choice **if the AI runs on a web/server runtime** (Node/Edge) and the mobile app talks to it.
- **Strong recommendation:** Do **not** call model providers directly from the app. Keep API keys and tool execution on the backend.
- **MVP shaping advice:**
  - Start with **non-streaming responses** (`assistant_text` returned as a whole) to reduce RN networking complexity.
  - Keep “actions” as the primary contract: the model outputs **typed actions** (create task, reschedule, upsert profile field), and the backend executes/validates them before returning results.

### 8.3 Backend: “basic backend” (minimum viable shape)

- **Verdict:** You want something boring and deployable quickly.
- **Recommended MVP shape (fits Vercel AI SDK well):**
  - **Backend runtime:** Next.js API routes (or a small Node server) hosting:
    - `/api/v0/chat/messages` (model call + action planning/execution)
    - CRUD endpoints in section 7
  - **Database:** hosted Postgres (e.g. Neon/Supabase) or SQLite during local dev; keep schema aligned with section 5.
  - **Identity without auth (pragmatic):** generate a **device/install id** and send it as `X-Install-Id` on every request so your “single-user, no auth” assumption doesn’t mix data across test devices.
