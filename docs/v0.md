

> This document specifies the **requirements for the first MVP** (what to build and how it behaves).
> For the long-term vision and adaptive loop, see `sisy/docs/vision.md`.

## 0. MVP goal, scope, and non-goals

- **MVP goal:** Evolve and adapt with the user to craft **the most suitable routine**—keeping them focused on a viable next step with minimal interaction.

- **MVP scope (must ship):**
  - Chat input available from every screen
  - Minimalist Present “now/next” view
  - Routine template storage/editing 
  - Lightweight profile (“Me”) view for what the system knows
- **Non-goals (MVP):**
  - Full calendar replacement / complex scheduling engine
  - Social / collaboration
  - Deep health analytics (medical-grade)

## 1. Brand identity & UX principles (MVP constraints)

- **Design language:** **Extreme Minimalism**
- **Interaction mood:** Present when needed, invisible when you are focused.
- **MVP UX constraints:**
  - **One-primary-action** per screen (everything else is secondary or hidden)
  - **No setup wall:** user can start with empty profile + empty routine
  - **Speed:** most interactions should be doable in <10 seconds


## 3. Functional modules (MVP requirements)

### The "Chat" Layer

SiSy is an always-available companion.

- **Persistent input (REQ-CHAT-1):** A chat input field is anchored above the navigation bar on **every screen** (Present, Routine, Me).
    
- **Context awareness (REQ-CHAT-2):** The input knows which tab is active and includes that context in the message payload.
  - **User Context:** The frontend injects the full `user_profile` and `user_routine` into the chat request (as `user_context`) so the agent has full visibility.
  - **Dynamic Hints:** The input placeholder changes to prompt relevant actions (e.g., "How is it going?" on Present, "Update profile?" on Me).
- **Smart Drawer (REQ-CHAT-3):** Tapping the input expands a drawer over current content showing recent chat history, without navigating away.
- **Typing Indicator (REQ-CHAT-5):** The UI shows a typing indicator when the agent is generating a response, providing feedback for the non-streaming delay.

**Acceptance criteria**
- **AC-CHAT-1:** Input is visible on Present/Routine/Me and remains usable after switching tabs.
- **AC-CHAT-2:** Opening/closing the drawer does not reset the underlying screen state.

### The Navigation Anchor

- **Layout (REQ-NAV-1):** **Four** icon-based buttons located at the very bottom of the screen.
    - **Navigation Hints (Green Dot):** A small green dot badge appears on the "Routine" or "Me" tab icon when Sisy makes updates in those areas, guiding the user to review changes tailored to them.
    
    1. **Present:** The minimalist page about the current or next Task.
        
    2. **Routine:** The page about the default routine template.
        
    3. **Me:** The page about the user profile, SiSy's learning about the user.

    4. **Settings:** A dedicated area for app-wide configuration and data management.
        
- **Behavior (REQ-NAV-2):** Single tap to switch. Double-tap on the active tab to scroll to the top (or refresh context).

**Acceptance criteria**
- **AC-NAV-1:** Switching tabs is instant and does not lose the current “now/next” task state.
- **AC-NAV-2:** Double-tap on active tab scrolls to top (or triggers refresh) consistently.

### 3.1 Present: Minimalist Command Center

- **Primary view (REQ-PRESENT-1):** A vertical timeline stack focused on the "Now" task, with reduced visibility for "Past" and "Next".
  - **Focused Visibility:** Only 3 tasks are visible when stationary (Past, Now, Next). Outlying tasks are hidden to reduce clutter.
  - **Infinite Scroll:** Users can scroll freely to see all past and upcoming tasks for the day.
  - **Snap-to-Focus:** The list snaps to perfectly center the nearest task when scrolling stops.
  - **Focus Persistence:** The list remembers the user's focus position until they navigate away from the tab, at which point it resets to "Now".

- **Interactions (Updated Phase 5/6):**
  -   **Vertical Scroll:** Smooth infinite scrolling with snap-to-focus behavior.
  -   **Universal Swipe (Unified):** Swipe Right on ANY visible task to **Quick Complete** locally (instant feedback).
  -   **Details:** Tap any task to open the **Command Modal**.
      -   **Actionable:** Complete (with optional **comment/log**), Skip, or Delay.
      -   **Edit Routine:** Direct access to edit the underlying routine item configuration (e.g., permanent time change).

- **Empty state (REQ-PRESENT-2):** Show something relaxing and encouraging.

**Acceptance criteria**
- **AC-PRESENT-1:** App visually emphasizes exactly 3 tasks (Center + Neighbors) when stationary.
- **AC-PRESENT-2:** Users can scroll to access all tasks for the day.
- **AC-PRESENT-3:** List snaps to center the nearest task on release.
- **AC-PRESENT-4:** Focus position persists until tab navigation resets it to "Now".
- **AC-PRESENT-5:** Swipe Right triggers "Quick Complete" instantly.
- **AC-PRESENT-6:** Tapping a task opens Details with Complete (w/ optional comment), Skip, Delay, and Edit-Routine options.

### 3.2 "Me" Interface

- **Function (REQ-ME-1):** Visualize the user profile as simple key-value fields organized into **Groups** (e.g., Basics / Health).
- **Layout (REQ-ME-2):** Render fields as **two-column rows** within their respective groups.
- **Customization (REQ-ME-4):** Users can customize all groups (create new groups, add fields to specific groups). Default groups (Basics, Health) are just starting points.
- **Long values (REQ-ME-3):** Values may be long strings and arbitrary text; the default overview should **truncate (ellipsis)** to keep rows compact.
  - When editing/viewing details, the full value should be accessible, inline edit mode for shot value or a dedicated detail view for long value).

- **Purpose:** Let users see how SiSy understands them.
- **Group Management (REQ-ME-5):**
  - **Atomic Deletion:** Deleting a group removes all attributes within it efficiently.
  - **Renaming:** Users can rename groups, which updates the group tag on all constituent attributes.

**Acceptance criteria**
- **AC-ME-1:** User can view all stored fields grouped by their "Group" attribute.
- **AC-ME-2:** User can edit or delete a field (even if “AI learned”) in MVP.
- **AC-ME-3:** User can create new profile fields and assign them to any Group (existing or new).
- **AC-ME-4:** User can delete an entire group and all its attributes in one action.


### 3.3 "Routine" Interface

- **Function (REQ-ROUTINE-1):** Store the user’s Routine Template (the default day structure).
    
- **Linkage (REQ-ROUTINE-2):** Routine is the “master template” referenced when generating today’s tasks.
- **Editing (REQ-ROUTINE-3):** User can add/edit/remove routine items. Modifications to routine item details (Title, Time, Auto-complete) must **immediately propagate** to any linked "todo" tasks for the current day.
- **Minimum editor UI (REQ-ROUTINE-4):**
  - **Timeline Layout:** Items are displayed in a timeline view (time on left, connected line, card on right).
  - **Modal Editing:** Tapping an item opens a detail modal to edit all fields.
  - **Fields:**
    - Title
    - Time (HH:MM)
    - **Description:** Optional details for the item. Supports **Markdown** formatting.
    - **Repeat Interval:** Custom days (default 1 for daily).
    - **Auto-complete toggle:** See REQ-ROUTINE-5.
  - **Delete action:** Available in modal with confirmation (in-modal logic).

-   **Auto-complete semantics (REQ-ROUTINE-5):**
  -   User can **opt an item into auto-completion** (e.g. “Wake up”).
  -   When an item is marked auto-completable, it should render with **lighter typography** so the user’s attention naturally lands on deliberate items (e.g. “Exercise”).

-   **Contextual Editing (REQ-ROUTINE-6):** The routine editor is accessible directly from the Task Details view of an active task, allowing for "in-the-moment" adjustments to the permanent plan.

**Acceptance criteria**
- **AC-ROUTINE-1:** Routine edits persist and immediately update any relevant pending (todo) tasks for the current day.
- **AC-ROUTINE-2:** Routine can be empty; app remains usable.
- **AC-ROUTINE-3:** User can modify items via modal (Title, Time, Description [Markdown supported], Repeat).
- **AC-ROUTINE-4:** User can toggle auto-complete on an item.
- **AC-ROUTINE-5:** Deletion is confirmed via modal UI ("Are you sure").
- **AC-ROUTINE-6:** User can view "History / Logs" for specific routine items within the editor modal, capturing completion comments and actions.
    


### 3.5 Daily Task Generation (Checklist Logic)

- **Behavior (REQ-DAILY-1):** The system automatically generates daily tasks based on the Routine Template.
- **Trigger:** Checks run on app startup (hydration) and periodically (every minute) to ensure "today's coverage".
- **Logic:**
    - For each item in the Routine Template:
        1. Check if a task linked to this item exists for **Today**.
        2. If NOT, check if it is due based on `repeat_interval`.
        3. If due (or never before generated), create the task for today.
- **Benefit:** Decouples "completing a task" from "spawning the next one". Users can skip days or start fresh without broken streaks.

### 3.4 "Settings" Interface (REQ-SETTINGS)

- **Function (REQ-SETTINGS-1):** A dedicated area for app-wide configuration and data management, keeping the core "Routine" and "Me" tabs focused on daily usage.
- **Data Management (REQ-SETTINGS-2):**
    - **Import/Export Routine:** User can export their current routine structure (JSON/text) to clipboard/file and import it back. 
    - **Import/Export Profile:** User can export their profile data (JSON) and import it, allowing backup or transfer of learned facts.
    - **Load Template:** Pre-configured templates (e.g., "Wellness") to bootstrap the user's routine. 
    - **Confirmation (REQ-SETTINGS-3):** Critical data actions (like replacing routine) must use in-app Modals for confirmation on Web, avoiding native browser alerts for stability.

## 4. Core MVP flows (minimum)

- **Flow A — Start from nothing:** open app → Present empty state → user types intent in Chat → system creates a Task (source=`chat`) → Present shows it as the next step.
- **Flow B — Disruption:** user types a state update (“I’m exhausted”) → system suggests a revised next step.
- **Flow C — Reschedule:** user slides time tweak on Present → confirm → optional reason capture.
- **Flow D — Completion:** user marks done → optional feeling check → next task appears.
- **Flow E — Routine edit:** user edits Routine template → future plans reference it.
    - **Highlighting:** Updated items are highlighted (colored border/background). The highlight **persists** until the user taps/clicks the item to acknowledge/edit it.
- **Flow F — Profile transparency:** user opens Me → sees learned fields → edits/deletes one.
    - **Highlighting:** Updated fields are highlighted. The highlight **persists** until the user explicitly interacts with the field (click/tap).
- **Flow G — Audit Log:** User opens Settings → Views "Audit Log" section to see a chronological history of all updates made by Sisy (Profile & Routine changes).

## 5. Minimal data model & events (MVP)

- **Task**
  - `id`, `title`, `scheduled_time` (optional), `status` (todo/done), `source` (routine/chat/system)
  - `routine_item_id` (optional, links to master routine item)
- **RoutineItem**
  - `id`, `title`, `time` (optional), `auto_complete` (boolean, default=false)
  - `description` (optional string)
  - `repeat_interval` (optional number, default=1 for daily)
- **ProfileField**
  - `key`, `value`, `group` (string, default "Other"), `source` (user/learned), `updated_at`
- **Events to capture**
  - `task_completed`, `task_rescheduled`, `state_reported`, `profile_field_edited`
  - **Logs**: Linked to specific `routine_item_id` where applicable (e.g., skip comments, reschedule reasons).


## 6. MVP “done” checklist

- User can complete **Flows A–F** end-to-end without errors.
- Present stays minimalist (one primary line) while still supporting reschedule + done.
- Routine and profile are optional (empty is valid).

## 7. API & Architecture (MVP)

> **Note:** The current MVP uses a **client-side first architecture**. All Task, Routine, and Profile data are managed locally via AsyncStorage/localStorage. The backend is minimal and stateless.

### 7.1 Architecture Overview

- **Frontend (React Native + Expo):** Manages all state locally. Responsible for Task generation, Routine management, Profile storage.
- **Backend (FastAPI):** Serves the AI chat endpoint only. Does not persist user data.
- **Data sync:** Not implemented in MVP. Each device maintains its own state.

### 7.2 Chat Endpoint (Active)

- **Send message**
  - `POST /chat`
  - Content-Type: `multipart/form-data`
  - Headers: `X-Install-Id` (device identifier)
  - Body:
    - `text`: "string" (required)
    - `tab`: "home|routine|me" (default: "home")
    - `conversation_id`: "string|null"
    - `image`: File (optional)
    - `user_context`: JSON string (optional, contains `{ profile: ..., routine: ... }`)
    - `message_history`: JSON string (optional, list of previous messages `[{role, text, ...}]`)
  - Response:
    - `{ "conversation_id": "string", "assistant_text": "string", "actions": [Action] }`
  - `Action` types:
    - `{ "type": "upsert_routine_item", "title": "string", "time": "HH:MM|null", "description": "string|null", "repeat_interval": "number|null", "auto_complete": "boolean|null" }` (Create)
    - `{ "type": "upsert_routine_item", "id": "string", ... }` (Update existing)
    - `{ "type": "upsert_profile_field", "key": "string", "value": "string", "group": "string|null" }`

### 7.3 Health Endpoint

- `GET /health`
  - Response: `{ "status": "ok", "agent_ready": boolean }`

### 7.4 Future Endpoints (Not Implemented)

The following endpoints are documented for future server-side data persistence but are **not currently implemented**:

- Task CRUD: `GET/POST/PATCH /api/v0/tasks`
- Routine CRUD: `GET/PUT /api/v0/routine`
- Profile CRUD: `GET/PUT/DELETE /api/v0/profile/fields`
- Events logging: `POST /api/v0/events`

## 8. Stack choices (MVP implementation review)

### 8.1 Mobile app: React Native + Expo (start with Expo Go)

- **Verdict:** Good for MVP speed and iteration.
- **Recommendation:** Use **Expo Go** for early prototyping, but plan to switch to **EAS builds / Expo Dev Client** as soon as you need any native module not bundled in Expo Go (or when you start sharing test builds).
- **Key constraints to acknowledge upfront:**
  - **Streaming AI UX:** true token streaming can be awkward on RN depending on your networking approach; keep MVP tolerant of “single response” (non-streaming) and add streaming later.
  - **Storage/offline:** decide early whether “offline-first” is a goal. If not, keep client state light and treat backend as source of truth.

### 8.2 AI layer: Vercel AI SDK

- **Verdict:** Good choice **if the AI runs on a web/server runtime** (Node/Edge) and the mobile app talks to it.
- **Strong recommendation:** Do **not** call model providers directly from the app. Keep API keys and tool execution on the backend.
- **MVP shaping advice:**
  - Start with **non-streaming responses** (`assistant_text` returned as a whole) to reduce RN networking complexity.
  - Keep “actions” as the primary contract: the model outputs **typed actions** (create task, reschedule, upsert profile field), and the backend executes/validates them before returning results.

### 8.3 Backend: “basic backend” (minimum viable shape)

- **Verdict:** You want something boring and deployable quickly.
- **Recommended MVP shape (fits Vercel AI SDK well):**
  - **Backend runtime:** Next.js API routes (or a small Node server) hosting:
    - `/api/v0/chat/messages` (model call + action planning/execution)
    - CRUD endpoints in section 7
  - **Database:** hosted Postgres (e.g. Neon/Supabase) or SQLite during local dev; keep schema aligned with section 5.
  - **Identity without auth (pragmatic):** generate a **device/install id** and send it as `X-Install-Id` on every request so your “single-user, no auth” assumption doesn’t mix data across test devices.
